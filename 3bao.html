<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>富貴三寶-練習版(Q-6-4)</title>
<style>
  :root{--bg:#0b1520;--panel:#0f2233;--accent:#34d399;--muted:#9ca3af;--danger:#ef4444;--warn:#f59e0b;--text:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 700px at 50% -10%,#1d3557 0%,#0b1520 60%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid #173047;background:#0f2233aa;backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:20px;letter-spacing:.5px}
  .container{max-width:1100px;margin:18px auto;padding:0 12px;display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:980px){.container{grid-template-columns:1.3fr 1fr;gap:16px}}
  .left{display:flex;flex-direction:column}
  #panel-table{order:-2}
  #panel-bets{order:-1}
  #panel-pays{order:0}
  .card{background:linear-gradient(180deg,#0f2233 0%,#0c1a28 100%);border:1px solid #1a3347;border-radius:18px;box-shadow:0 12px 30px #0009,inset 0 0 0 1px #17304780}
  .card h2{margin:0 0 10px 0;font-size:16px;font-weight:700;color:#cfe6ff}
  .pad{padding:14px}
  .controls{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:980px){.controls{grid-template-columns:repeat(2,1fr)}}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row .btn{flex:1 0 auto}
  label{font-size:13px;color:#cbd5e1;display:block;margin-bottom:6px}
  .subtle{font-size:12px;color:#94a3b8}
  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg .btn{flex:1 0 auto;padding:10px 12px;border-radius:12px;background:#18344a;color:#e5e7eb;border:1px solid #2a4a63;transition:all .18s}
  .seg .btn:hover{background:#1c3c55}
  .seg .btn.active{background:linear-gradient(180deg,#1fb79f 0%,#34d399 100%);color:#0a141e;border-color:#1d8f77;box-shadow:0 6px 16px #0007}
  .field{background:#0b1d2b;border:1px solid #163149;border-radius:14px;padding:12px}
  button{cursor:pointer;border:none;border-radius:12px;font-weight:700}
  .btn{background:#18344a;color:#e5e7eb;border:1px solid #2a4a63;text-align:center}
  .btn:hover{background:#1c3c55}
  .btn-primary{background:var(--accent);color:#0a141e}
  .btn-ghost{background:transparent;border:1px dashed #355a76;color:#cfe6ff}
  .grid{display:grid;gap:10px}
  .two{grid-template-columns:1fr 1fr}
  .three{grid-template-columns:repeat(3,1fr)}
  .money{font-variant-numeric:tabular-nums}
  .table{position:relative;padding:14px;border-radius:18px;background:radial-gradient(900px 420px at 50% -10%,#0f3b2e 0%,#061710 70%);border:1px solid #1a5d47;min-height:220px;box-shadow:inset 0 10px 40px #0008}
  .divider{height:1px;background:#1a3347;margin:10px 0}
  .section-title{opacity:.9;margin:0 0 6px 0;font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#9fe0c7;text-align:center}
  .status{min-height:28px;color:#cbd5e1}
  .status strong{color:#fff}
  .cards{display:flex;gap:8px;flex-wrap:nowrap;justify-content:center}
  .card3{width:84px;height:120px;border-radius:14px;background:linear-gradient(180deg,#164a6b 0%,#0f2a40 100%);border:1px solid #2a4a63;display:flex;align-items:center;justify-content:center;color:#e5e7eb;font-weight:800;position:relative;box-shadow:0 10px 18px #000a, inset 0 0 0 1px #3b6b89}
  .card3::before{content:"";position:absolute;inset:0;border-radius:14px;box-shadow:0 0 0 1px #0006, 0 6px 16px #0007;pointer-events:none}
  .card3.pop{animation:pop .22s ease-out}
  @keyframes pop{0%{transform:scale(.9);opacity:.2}100%{transform:scale(1);opacity:1}}
  .card3 .suit{font-size:30px;position:absolute;bottom:6px;right:8px;opacity:.9}
  @media (max-width:420px){.card3{width:72px;height:104px}.card3 .suit{font-size:26px}}
  .log{max-height:220px;overflow:auto;border-radius:10px;border:1px solid #1a3347;background:#0a1824;padding:10px;font-size:13px}
  .log .rowline{display:flex;justify-content:space-between;gap:10px}
  .log .amt{white-space:nowrap}
  .muted{opacity:.55}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0a1824;border:1px solid #1a3347;color:#cfe6ff;font-size:12px}
  .pnltag{padding:2px 8px;border-radius:999px;font-weight:800}
  .pnltag.win{background:#063d2c;color:#9ff2cf;border:1px solid #1a5d47}
  .pnltag.lose{background:#3d0610;color:#ffc0c0;border:1px solid #7a2f39}
  .btn-primary:hover{filter:brightness(1.05)}
  .hint{font-size:11px;color:#94a3b8;text-align:center}
  .dealer-player{display:flex;flex-direction:column;gap:16px}
  /* 主題 */
  .theme-vegas{--accent:#f6c453;--panel:#1f2937;--text:#f5f5f5}
  .theme-vegas .table{background:radial-gradient(900px 420px at 50% -10%,#3e2f00 0%,#1a1400 70%);border-color:#8b6b00}
  .theme-vegas header{background:#2b1f03aa;border-bottom-color:#5a4608}
  .theme-vegas .seg .btn.active{background:linear-gradient(180deg,#ffd76a 0%,#f6c453 100%);color:#1a1400;border-color:#a77b00}
  .theme-neo{--accent:#34d399}
  /* 浮動盈虧標籤 */
  .float-layer{position:absolute;inset:0;pointer-events:none}
  .float-pnl{position:absolute;right:10px;top:10px;font-weight:900;padding:6px 10px;border-radius:12px;background:#0a1824cc;border:1px solid #1a3347}
  .float-pnl.win{color:#9ff2cf}
  .float-pnl.lose{color:#ffc0c0}
  @keyframes risefade{0%{transform:translateY(0);opacity:0}10%{opacity:1}100%{transform:translateY(-40px);opacity:0}}
  .float-pnl{animation:risefade 1.2s ease-out forwards}
  /* 按鈕動效 */
  .btn-anim{transition:transform .12s ease, filter .12s ease}
  .btn-anim.pulse{animation:pulseIn .18s ease-out}
  .btn-anim.shake{animation:shake .22s ease-out}
  @keyframes pulseIn{0%{transform:scale(.95);filter:brightness(.9)}100%{transform:scale(1);filter:brightness(1)}}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
  /* 動作按鈕統一尺寸 */
  #panel-bets .row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  #panel-bets .row button{width:100%;padding:14px;font-size:15px}
</style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <h1>富貴三寶練習版(Q-6-4)</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="themeBtn" class="btn" style="white-space:nowrap" onclick="toggleTheme()">切換主題</button>
      </div>
    </div>
  </header>
  <main class="container">
    <section class="left">
      <!-- 賭桌置頂 -->
      <div class="card pad" id="panel-table">
        <h2>賭桌</h2>
        <div class="table"><div id="floatLayer" class="float-layer"></div>
          <div class="dealer-player">
            <div>
              <p class="section-title">莊家手牌</p>
              <div class="cards" id="dealerCards"></div>
              <p class="hint" id="dealerInfo"></p>
            </div>
            <div>
              <p class="section-title">玩家手牌</p>
              <div class="cards" id="playerCards"></div>
              <p class="hint" id="playerInfo"></p>
            </div>
          </div>
          <div class="divider"></div>
          <div class="grid three kpi">
            <div class="item"><div class="subtle">本金</div><div class="money" id="bankrollView">HKD 20,000</div></div>
            <div class="item"><div class="subtle">本局盈虧</div><div class="money" id="pnlView">HKD 0</div></div>
            <div class="item"><div class="subtle">總局數 / 勝率</div><div class="money" id="statsView">0 / 0%</div></div>
          </div>
        </div>
      </div>

      <!-- 下注區：Ante 僅「不下 / 300 / 500」，Pair+ 僅「不下 / 300 / 500」 -->
      <div class="card pad" id="panel-bets">
        <h2>下注區</h2>
        <div class="controls">
          <div class="field">
            <label>底注（Ante）</label>
            <input id="ante" type="hidden" value="300" />
            <div class="seg">
              <button class="btn" data-ante="0" onclick="setAnte(0)">不下</button>
              <button class="btn active" data-ante="300" onclick="setAnte(300)">300</button>
              <button class="btn" data-ante="500" onclick="setAnte(500)">500</button>
            </div>
            <div class="subtle" style="margin-top:6px">跟注（Play）會自動等額加注</div>
          </div>
          <div class="field">
            <label>側注（Pair+）</label>
            <input id="pairplus" type="hidden" value="300" />
            <div class="seg">
              <button class="btn" data-pp="0" onclick="setPP(0)">不下</button>
              <button class="btn active" data-pp="300" onclick="setPP(300)">300</button>
              <button class="btn" data-pp="500" onclick="setPP(500)">500</button>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn-primary" id="btnDeal" onclick="deal()">發牌</button>
          <button class="btn btn-anim" id="btnPlay" onclick="playerPlay()" disabled>跟注</button>
          <button class="btn-ghost btn-anim" id="btnFold" onclick="playerFold()" disabled>棄牌</button>
          <button class="btn" onclick="newRound(true)">整理</button>
        </div>
        <p class="status" id="status"></p>
      </div>

      <!-- 賠率說明 -->
      <div class="card pad" id="panel-pays">
        <h2>賠率（依你指定）</h2>
        <ul class="subtle">
          <li><strong>側注（Pair+）</strong>：一對 <b>1x</b>、同花 <b>4x</b>、順子 <b>5x</b>、三條 <b>25x</b>、同花順 <b>40x</b>（不中＝沒到一對 → 0；<b>派發含本金</b>）</li>
          <li><strong>主體 Ante Bonus</strong>：同花 <b>1x</b>、順子 <b>2x</b>（玩家達牌型時加發；三條/同花順未設定加碼）</li>
          <li><strong>莊家合格</strong>：至少 <b>Q 高</b> 才比牌；不合格 → <b>Ante 1:1</b>，Play 退回。</li>
          <li><strong>牌型排名</strong>：高牌 &lt; 對子 &lt; 同花 &lt; 順子 &lt; 三條 &lt; 同花順（A‑2‑3 最小順；Q‑K‑A 最大順）。</li>
        </ul>
      </div>
    </section>

    <aside class="right">
      <div class="card pad" style="height:100%">
        <h2>紀錄 / 訊息</h2>
        <div id="log" class="log"></div>
      </div>
    </aside>
  </main>

<script>
// ====== 公用工具 ======
function money(n){return 'HKD\u00a0'+Number(n).toLocaleString('en-US',{maximumFractionDigits:0});}
function log(msg){const el=document.getElementById('log');el.innerHTML=`<div class="rowline">${msg}</div>`+el.innerHTML;}

// 音效（純前端 WebAudio）
let _audioCtx=null;function ac(){if(!_audioCtx){_audioCtx=new (window.AudioContext||window.webkitAudioContext)()}return _audioCtx}
function beep(freq=880, dur=0.08, vol=0.05){try{const ctx=ac();const o=ctx.createOscillator();const g=ctx.createGain();o.type='sine';o.frequency.value=freq;g.gain.value=vol;o.connect(g);g.connect(ctx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);o.stop(ctx.currentTime+dur);}catch(e){}}
function playChipDing(){beep(1200,0.06,0.04);} function playActionDing(){beep(700,0.07,0.05);}

// 主題切換 + 記憶
function toggleTheme(){
  const b=document.body, V='theme-vegas', N='theme-neo';
  if(b.classList.contains(V)){b.classList.remove(V);b.classList.add(N);localStorage.setItem('theme','neo');}
  else if(b.classList.contains(N)){b.classList.remove(N);localStorage.setItem('theme','default');}
  else{b.classList.add(V);localStorage.setItem('theme','vegas');}
}
(function loadPrefs(){const t=localStorage.getItem('theme');if(t==='vegas')document.body.classList.add('theme-vegas');else if(t==='neo')document.body.classList.add('theme-neo');})();

// ====== 牌組與抽牌 ======
const SUITS=['♠','♥','♦','♣'];
const RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
function buildShoe(decks=5){const cards=[];for(let d=0;d<decks;d++){for(const s of SUITS){for(const r of RANKS){cards.push({suit:s,rank:r});}}}for(let i=cards.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[cards[i],cards[j]]=[cards[j],cards[i]]}return cards;}
let shoe=[];
function draw(n){const out=[];for(let i=0;i<n;i++){out.push(shoe.pop());}return out;}

// ====== 牌型分析與比較 ======
const rankValue=r=>({'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14}[r]);
function analyze3(cards){
  const vals=cards.map(c=>rankValue(c.rank)).sort((a,b)=>a-b);const suits=cards.map(c=>c.suit);const counts={};for(const v of vals){counts[v]=(counts[v]||0)+1}
  const isFlush=(new Set(suits)).size===1;let isStraight=(vals[2]-vals[1]===1&&vals[1]-vals[0]===1);if(JSON.stringify(vals)==='[2,3,14]'){isStraight=true}
  const have3=Object.values(counts).includes(3);const havePair=Object.values(counts).includes(2);
  // 0高牌 1對 2同花 3順 4三條 5同花順
  let cat=0;if(have3)cat=4;else if(isStraight&&isFlush)cat=5;else if(isStraight)cat=3;else if(isFlush)cat=2;else if(havePair)cat=1;else cat=0;
  let sortedForCompare=[...vals];if(havePair){const pairVal=Number(Object.keys(counts).find(k=>counts[k]===2));const single=Number(Object.keys(counts).find(k=>counts[k]===1));sortedForCompare=[single,pairVal,pairVal]}
  let straightHigh=null;if(isStraight){straightHigh=(JSON.stringify(vals)==='[2,3,14]')?3:vals[2]}
  return {cat,vals,suits,havePair,have3,isFlush,isStraight,straightHigh,cmpKey:sortedForCompare};
}
function compareHands(a,b){
  if(a.cat!==b.cat)return a.cat-b.cat; if(a.cat===5||a.cat===3){return a.straightHigh-b.straightHigh}
  if(a.cat===2||a.cat===0){for(let i=2;i>=0;i--){if(a.vals[i]!==b.vals[i])return a.vals[i]-b.vals[i]}return 0}
  if(a.cat===4){return a.vals[1]-b.vals[1]} if(a.cat===1){if(a.cmpKey[1]!==b.cmpKey[1])return a.cmpKey[1]-b.cmpKey[1];return a.cmpKey[0]-b.cmpKey[0]}
  return 0;
}
function handLabel(ana){return ['高牌','一對','同花','順子','三條','同花順'][ana.cat];}

// ====== 規則（依你指定） ======
const SIDE_PAYS={pair:1,flush:4,straight:5,trips:25,straightflush:40};
const ANTE_BONUS={flush:1,straight:2,trips:0,straightflush:0};
function qualify(da){ if(da.cat>=1) return true; return da.vals[2]>=12 /*Q*/ }

// ====== 畫面輔助 ======
function renderCards(containerId,cards,hide=false){
  const el=document.getElementById(containerId);el.innerHTML='';
  cards.forEach(c=>{
    const div=document.createElement('div');div.className='card3 pop';
    if(hide){div.innerHTML='<span class="muted">🂠</span>';}else{
      const red=(c.suit==='♥'||c.suit==='♦');div.style.borderColor=red?'#7a2f39':'#2a4a63';div.style.color=red?'#fecaca':'#e5e7eb';
      div.innerHTML=`<div style="font-size:20px">${c.rank}</div><div class="suit">${c.suit}</div>`;}
    el.appendChild(div);
  });
}
function floatPnl(pnl){const layer=document.getElementById('floatLayer');if(!layer)return;const tag=document.createElement('div');tag.className='float-pnl '+(pnl>=0?'win':'lose');tag.textContent=(pnl>=0?'+':'')+money(pnl).replace('HKD\u00A0','');layer.appendChild(tag);setTimeout(()=>tag.remove(),1300);}

// ====== 狀態 ======
let bankroll=20000;let stats={rounds:0,wins:0};let round=null;
function updateHUD(){document.getElementById('bankrollView').textContent=money(bankroll);if(!round){document.getElementById('pnlView').textContent='HKD\u00A00'}const wr=stats.rounds?Math.round(stats.wins*100/stats.rounds):0;document.getElementById('statsView').textContent=`${stats.rounds} / ${wr}%`;}
function setAnte(v){const el=document.getElementById('ante');if(el)el.value=v;document.querySelectorAll('[data-ante]').forEach(btn=>btn.classList.toggle('active',Number(btn.dataset.ante)===Number(v)));playChipDing();}
function setPP(v){const el=document.getElementById('pairplus');if(el)el.value=v;document.querySelectorAll('[data-pp]').forEach(btn=>btn.classList.toggle('active',Number(btn.dataset.pp)===Number(v)));playChipDing();}

// ====== 結算輔助 ======
function calcPairPlus(pa,stake){if(stake<=0)return 0; if(pa.cat===5)return stake*(SIDE_PAYS.straightflush+1); if(pa.cat===4)return stake*(SIDE_PAYS.trips+1); if(pa.cat===3)return stake*(SIDE_PAYS.straight+1); if(pa.cat===2)return stake*(SIDE_PAYS.flush+1); if(pa.cat===1)return stake*(SIDE_PAYS.pair+1); return 0;}
function calcAnteBonus(pa,ante){let b=0;if(pa.cat===5)b+=ante*ANTE_BONUS.straightflush; if(pa.cat===4)b+=ante*ANTE_BONUS.trips; if(pa.cat===3)b+=ante*ANTE_BONUS.straight; if(pa.cat===2)b+=ante*ANTE_BONUS.flush;return b}

// ====== 遊戲流程 ======
function deal(){
  if(round&&!round.settled){log('尚未結算，請先跟注或棄牌');return}
  const ante=Number(document.getElementById('ante').value)||0;const pp=Number(document.getElementById('pairplus').value)||0;
  if(ante<=0&&pp<=0){log('請至少選擇一種下注');return}
  if(bankroll<ante+pp){log('本金不足');return}
  const startBankroll=bankroll;bankroll-=(ante+pp);
  // 每局重洗：重新建立 5 副牌鞋
  shoe=buildShoe(5);
  const pc=draw(3),dc=draw(3);const pa=analyze3(pc),da=analyze3(dc);
  round={pc,dc,pa,da,ante,pp,play:0,settled:false,startBankroll};
  renderCards('playerCards',pc);
  const ppOnly=(ante===0&&pp>0);
  if(ppOnly){
    renderCards('dealerCards',dc,false);
    document.getElementById('playerInfo').textContent=`你的牌：${handLabel(pa)}（只下側注自動結算）`;
    document.getElementById('dealerInfo').textContent=`莊家：${handLabel(da)}`;
    document.getElementById('btnPlay').disabled=true;document.getElementById('btnFold').disabled=true;document.getElementById('btnDeal').disabled=true;
    settle('PP_ONLY');
  }else{
    renderCards('dealerCards',[{},{},{}],true);
    document.getElementById('playerInfo').textContent=`你的牌：${handLabel(pa)}`;
    document.getElementById('dealerInfo').textContent='莊家：面朝下';
    document.getElementById('status').innerHTML='請選擇 <strong>跟注</strong> 或 <strong>棄牌</strong>。';
    document.getElementById('btnPlay').disabled=false;document.getElementById('btnFold').disabled=false;document.getElementById('btnDeal').disabled=true;
  }
  updateHUD();
}

function playerPlay(){
  if(!round||round.settled)return;
  const btn=document.getElementById('btnPlay'); if(btn){btn.classList.remove('pulse','shake');void btn.offsetWidth;btn.classList.add('pulse')}
  if(bankroll<round.ante){if(btn){btn.classList.remove('pulse');btn.classList.add('shake')}log('本金不足以跟注');return}
  bankroll-=round.ante;round.play=round.ante; playActionDing();
  renderCards('dealerCards',round.dc,false);
  settle('PLAY');
}

function playerFold(){
  if(!round||round.settled)return;
  const btn=document.getElementById('btnFold'); if(btn){btn.classList.remove('pulse');void btn.offsetWidth;btn.classList.add('pulse')}
  playActionDing(); if(navigator.vibrate){navigator.vibrate(20)}
  settle('FOLD');
}

function settle(mode){
  const {pa,da,ante,play,pp,startBankroll}=round;const pairPlusReturn=calcPairPlus(pa,pp);let mainWin=0;const detail=[];

  if(mode==='PP_ONLY'){
    if(pairPlusReturn>0){bankroll+=pairPlusReturn;detail.push(`側注派發（含本金） ${money(pairPlusReturn)}`)}else{detail.push('側注未中（一對以上才派彩）')}
    round.settled=true;stats.rounds++;if(pairPlusReturn>0){stats.wins++;}
    const pnl=bankroll-startBankroll;document.getElementById('pnlView').textContent=money(pnl);document.getElementById('status').innerHTML='<strong>只下側注：已自動結算</strong>';floatPnl(pnl);
    log(`<span>${detail.join('；')}。</span><span class=\"amt\">${pnl>=0?`<span class=\\\"pnltag win\\\">+${money(pnl)}</span>`:`<span class=\\\"pnltag lose\\\">${money(pnl)}</span>`}</span>`);
    updateHUD();document.getElementById('btnDeal').disabled=false;document.getElementById('btnPlay').disabled=true;document.getElementById('btnFold').disabled=true;return;
  }

  if(mode==='FOLD'){
    // 棄牌時，側注一同輸掉，不退回
    detail.push('你選擇棄牌；失去 Ante 與側注');
  } else {
    const cmp=compareHands(pa,da); const dealerQ=qualify(da);
    if(!dealerQ){
      bankroll+=ante*2; // Ante 1:1（含本金）
      bankroll+=play;   // Play 退回本金
      mainWin+=ante;    // 盈利 = Ante
      detail.push('莊家不合格（Q 以下），Ante 1:1，Play 退回');
    } else {
      if(cmp>0){
        bankroll+=(ante*2+play*2); // 主體贏 1:1（含本金）
        mainWin+=(ante+play);
        detail.push('你贏過莊家：Ante 與 Play 各 1:1');
      } else if(cmp<0){
        detail.push('你輸給莊家：Ante 與 Play 皆失去');
      } else {
        bankroll+=(ante+play); // 平手退回本金
        detail.push('與莊家平手：Ante 與 Play 退回');
      }
    }
    const bonus=calcAnteBonus(pa,ante);if(bonus>0){bankroll+=bonus;mainWin+=bonus;detail.push(`主體加碼：${handLabel(pa)} 追加 ${money(bonus)}`)}
    if(pairPlusReturn>0){bankroll+=pairPlusReturn;detail.push(`側注派發（含本金） ${money(pairPlusReturn)}`)}
  }

  round.settled=true;stats.rounds++;if(mainWin>0||pairPlusReturn>0){stats.wins++}
  renderCards('dealerCards',round.dc,false);document.getElementById('dealerInfo').textContent=`莊家：${handLabel(da)}`;
  const pnl=bankroll-startBankroll;document.getElementById('pnlView').textContent=money(pnl);floatPnl(pnl);document.getElementById('status').innerHTML=`<strong>結算完成</strong>｜你：${handLabel(pa)}　莊家：${handLabel(da)}。`;
  log(`<span>${detail.join('；')}。</span><span class=\"amt\">${pnl>=0?`<span class=\\\"pnltag win\\\">+${money(pnl)}</span>`:`<span class=\\\"pnltag lose\\\">${money(pnl)}</span>`}</span>`);
  updateHUD();document.getElementById('btnDeal').disabled=false;document.getElementById('btnPlay').disabled=true;document.getElementById('btnFold').disabled=true;
}

function newRound(hard=false){if(hard){document.getElementById('playerCards').innerHTML='';document.getElementById('dealerCards').innerHTML='';document.getElementById('playerInfo').textContent='';document.getElementById('dealerInfo').textContent='';document.getElementById('status').textContent=''} round=null;document.getElementById('btnDeal').disabled=false;document.getElementById('btnPlay').disabled=true;document.getElementById('btnFold').disabled=true;document.getElementById('pnlView').textContent='HKD\u00A00'}

// ====== 自動測試（console 顯示） ======
(function runTests(){
  const ok=(name,cond)=>{if(!cond){console.error('Test failed:',name)}else{console.debug('Test ok:',name)}};
  ok('函式存在：deal()', typeof deal==='function');
  ok('函式存在：toggleTheme()', typeof toggleTheme==='function');
  // 分類
  ok('分類：高牌', analyze3([{rank:'A',suit:'♠'},{rank:'7',suit:'♦'},{rank:'4',suit:'♣'}]).cat===0);
  ok('分類：一對', analyze3([{rank:'K',suit:'♠'},{rank:'K',suit:'♥'},{rank:'3',suit:'♣'}]).cat===1);
  ok('分類：同花', analyze3([{rank:'2',suit:'♦'},{rank:'6',suit:'♦'},{rank:'J',suit:'♦'}]).cat===2);
  ok('分類：順子 A-2-3', analyze3([{rank:'A',suit:'♠'},{rank:'2',suit:'♥'},{rank:'3',suit:'♣'}]).cat===3);
  ok('分類：三條', analyze3([{rank:'9',suit:'♠'},{rank:'9',suit:'♥'},{rank:'9',suit:'♦'}]).cat===4);
  ok('分類：同花順 Q-K-A', analyze3([{rank:'Q',suit:'♠'},{rank:'K',suit:'♠'},{rank:'A',suit:'♠'}]).cat===5);
  // 比較：順子 > 同花
  const straight=analyze3([{rank:'4',suit:'♠'},{rank:'5',suit:'♥'},{rank:'6',suit:'♣'}]);
  const flush=analyze3([{rank:'2',suit:'♦'},{rank:'7',suit:'♦'},{rank:'K',suit:'♦'}]);
  ok('比較：順子勝同花', compareHands(straight,flush)>0);
  // 棄牌時側注一同輸掉：Ante=300, PP=300，棄牌 → 損失 600
  (function(){const before=20000; const ante=300, pp=300; let bank = before - (ante + pp); const pnl = bank - before; ok('棄牌：側注一同輸掉、損失 -600', pnl===-600);})();
  // Ante Bonus 規格：同花 1x、順子 2x
  (function(){ ok('AnteBonus 同花 1x', calcAnteBonus({cat:2},300)===300); ok('AnteBonus 順子 2x', calcAnteBonus({cat:3},300)===600); })();
  // 你的案例：Ante=300, Play=300, Pair+=300；玩家一對勝莊家高牌 → +900（含側注）
  (function(){ const stakeAnte=300, stakePlay=300, stakePP=300; const before=20000; let after = before - (stakeAnte + stakePP) - stakeAnte; after += (stakeAnte*2 + stakePlay*2) + (stakePP*2); const pnl = after - before; ok('一對勝高牌（含側注）應 +900', pnl===900); })();
})();

// 初始化
(function init(){ setAnte(Number(document.getElementById('ante').value)); setPP(Number(document.getElementById('pairplus').value)); updateHUD(); })();
</script>
</body>
</html>
