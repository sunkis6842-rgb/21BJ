<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å¯Œè²´ä¸‰å¯¶-ç·´ç¿’ç‰ˆ(Q-6-4)</title>
<style>
  :root{--bg:#0b1520;--panel:#0f2233;--accent:#34d399;--muted:#9ca3af;--danger:#ef4444;--warn:#f59e0b;--text:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 700px at 50% -10%,#1d3557 0%,#0b1520 60%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid #173047;background:#0f2233aa;backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:20px;letter-spacing:.5px}
  .container{max-width:1100px;margin:18px auto;padding:0 12px;display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:980px){.container{grid-template-columns:1.3fr 1fr;gap:16px}}
  .left{display:flex;flex-direction:column}
  #panel-table{order:-2}
  #panel-bets{order:-1}
  #panel-pays{order:0}
  .card{background:linear-gradient(180deg,#0f2233 0%,#0c1a28 100%);border:1px solid #1a3347;border-radius:18px;box-shadow:0 12px 30px #0009,inset 0 0 0 1px #17304780}
  .card h2{margin:0 0 10px 0;font-size:16px;font-weight:700;color:#cfe6ff}
  .pad{padding:14px}
  .controls{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:980px){.controls{grid-template-columns:repeat(2,1fr)}}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row .btn{flex:1 0 auto}
  label{font-size:13px;color:#cbd5e1;display:block;margin-bottom:6px}
  .subtle{font-size:12px;color:#94a3b8}
  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg .btn{flex:1 0 auto;padding:10px 12px;border-radius:12px;background:#18344a;color:#e5e7eb;border:1px solid #2a4a63;transition:all .18s}
  .seg .btn:hover{background:#1c3c55}
  .seg .btn.active{background:linear-gradient(180deg,#1fb79f 0%,#34d399 100%);color:#0a141e;border-color:#1d8f77;box-shadow:0 6px 16px #0007}
  .field{background:#0b1d2b;border:1px solid #163149;border-radius:14px;padding:12px}
  button{cursor:pointer;border:none;border-radius:12px;font-weight:700}
  .btn{background:#18344a;color:#e5e7eb;border:1px solid #2a4a63;text-align:center}
  .btn:hover{background:#1c3c55}
  .btn-primary{background:var(--accent);color:#0a141e}
  .btn-ghost{background:transparent;border:1px dashed #355a76;color:#cfe6ff}
  .grid{display:grid;gap:10px}
  .two{grid-template-columns:1fr 1fr}
  .three{grid-template-columns:repeat(3,1fr)}
  .money{font-variant-numeric:tabular-nums}
  .table{position:relative;padding:14px;border-radius:18px;background:radial-gradient(900px 420px at 50% -10%,#0f3b2e 0%,#061710 70%);border:1px solid #1a5d47;min-height:220px;box-shadow:inset 0 10px 40px #0008}
  .divider{height:1px;background:#1a3347;margin:10px 0}
  .section-title{opacity:.9;margin:0 0 6px 0;font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#9fe0c7;text-align:center}
  .status{min-height:28px;color:#cbd5e1}
  .status strong{color:#fff}
  .cards{display:flex;gap:8px;flex-wrap:nowrap;justify-content:center}
  .card3{width:84px;height:120px;border-radius:14px;background:linear-gradient(180deg,#164a6b 0%,#0f2a40 100%);border:1px solid #2a4a63;display:flex;align-items:center;justify-content:center;color:#e5e7eb;font-weight:800;position:relative;box-shadow:0 10px 18px #000a, inset 0 0 0 1px #3b6b89}
  .card3::before{content:"";position:absolute;inset:0;border-radius:14px;box-shadow:0 0 0 1px #0006, 0 6px 16px #0007;pointer-events:none}
  .card3.pop{animation:pop .22s ease-out}
  @keyframes pop{0%{transform:scale(.9);opacity:.2}100%{transform:scale(1);opacity:1}}
  .card3 .suit{font-size:30px;position:absolute;bottom:6px;right:8px;opacity:.9}
  @media (max-width:420px){.card3{width:72px;height:104px}.card3 .suit{font-size:26px}}
  .log{max-height:220px;overflow:auto;border-radius:10px;border:1px solid #1a3347;background:#0a1824;padding:10px;font-size:13px}
  .log .rowline{display:flex;justify-content:space-between;gap:10px}
  .log .amt{white-space:nowrap}
  .muted{opacity:.55}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0a1824;border:1px solid #1a3347;color:#cfe6ff;font-size:12px}
  .pnltag{padding:2px 8px;border-radius:999px;font-weight:800}
  .pnltag.win{background:#063d2c;color:#9ff2cf;border:1px solid #1a5d47}
  .pnltag.lose{background:#3d0610;color:#ffc0c0;border:1px solid #7a2f39}
  .btn-primary:hover{filter:brightness(1.05)}
  .hint{font-size:11px;color:#94a3b8;text-align:center}
  .dealer-player{display:flex;flex-direction:column;gap:16px}
  /* ä¸»é¡Œ */
  .theme-vegas{--accent:#f6c453;--panel:#1f2937;--text:#f5f5f5}
  .theme-vegas .table{background:radial-gradient(900px 420px at 50% -10%,#3e2f00 0%,#1a1400 70%);border-color:#8b6b00}
  .theme-vegas header{background:#2b1f03aa;border-bottom-color:#5a4608}
  .theme-vegas .seg .btn.active{background:linear-gradient(180deg,#ffd76a 0%,#f6c453 100%);color:#1a1400;border-color:#a77b00}
  .theme-neo{--accent:#34d399}
  /* æµ®å‹•ç›ˆè™§æ¨™ç±¤ */
  .float-layer{position:absolute;inset:0;pointer-events:none}
  .float-pnl{position:absolute;right:10px;top:10px;font-weight:900;padding:6px 10px;border-radius:12px;background:#0a1824cc;border:1px solid #1a3347}
  .float-pnl.win{color:#9ff2cf}
  .float-pnl.lose{color:#ffc0c0}
  @keyframes risefade{0%{transform:translateY(0);opacity:0}10%{opacity:1}100%{transform:translateY(-40px);opacity:0}}
  .float-pnl{animation:risefade 1.2s ease-out forwards}
  /* æŒ‰éˆ•å‹•æ•ˆ */
  .btn-anim{transition:transform .12s ease, filter .12s ease}
  .btn-anim.pulse{animation:pulseIn .18s ease-out}
  .btn-anim.shake{animation:shake .22s ease-out}
  @keyframes pulseIn{0%{transform:scale(.95);filter:brightness(.9)}100%{transform:scale(1);filter:brightness(1)}}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
  /* å‹•ä½œæŒ‰éˆ•çµ±ä¸€å°ºå¯¸ */
  #panel-bets .row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  #panel-bets .row button{width:100%;padding:14px;font-size:15px}
</style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <h1>å¯Œè²´ä¸‰å¯¶ç·´ç¿’ç‰ˆ(Q-6-4)</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="themeBtn" class="btn" style="white-space:nowrap" onclick="toggleTheme()">åˆ‡æ›ä¸»é¡Œ</button>
      </div>
    </div>
  </header>
  <main class="container">
    <section class="left">
      <!-- è³­æ¡Œç½®é ‚ -->
      <div class="card pad" id="panel-table">
        <h2>è³­æ¡Œ</h2>
        <div class="table"><div id="floatLayer" class="float-layer"></div>
          <div class="dealer-player">
            <div>
              <p class="section-title">èŠå®¶æ‰‹ç‰Œ</p>
              <div class="cards" id="dealerCards"></div>
              <p class="hint" id="dealerInfo"></p>
            </div>
            <div>
              <p class="section-title">ç©å®¶æ‰‹ç‰Œ</p>
              <div class="cards" id="playerCards"></div>
              <p class="hint" id="playerInfo"></p>
            </div>
          </div>
          <div class="divider"></div>
          <div class="grid three kpi">
            <div class="item"><div class="subtle">æœ¬é‡‘</div><div class="money" id="bankrollView">HKDÂ 20,000</div></div>
            <div class="item"><div class="subtle">æœ¬å±€ç›ˆè™§</div><div class="money" id="pnlView">HKDÂ 0</div></div>
            <div class="item"><div class="subtle">ç¸½å±€æ•¸ / å‹ç‡</div><div class="money" id="statsView">0 / 0%</div></div>
          </div>
        </div>
      </div>

      <!-- ä¸‹æ³¨å€ï¼šAnte åƒ…ã€Œä¸ä¸‹ / 300 / 500ã€ï¼ŒPair+ åƒ…ã€Œä¸ä¸‹ / 300 / 500ã€ -->
      <div class="card pad" id="panel-bets">
        <h2>ä¸‹æ³¨å€</h2>
        <div class="controls">
          <div class="field">
            <label>åº•æ³¨ï¼ˆAnteï¼‰</label>
            <input id="ante" type="hidden" value="300" />
            <div class="seg">
              <button class="btn" data-ante="0" onclick="setAnte(0)">ä¸ä¸‹</button>
              <button class="btn active" data-ante="300" onclick="setAnte(300)">300</button>
              <button class="btn" data-ante="500" onclick="setAnte(500)">500</button>
            </div>
            <div class="subtle" style="margin-top:6px">è·Ÿæ³¨ï¼ˆPlayï¼‰æœƒè‡ªå‹•ç­‰é¡åŠ æ³¨</div>
          </div>
          <div class="field">
            <label>å´æ³¨ï¼ˆPair+ï¼‰</label>
            <input id="pairplus" type="hidden" value="300" />
            <div class="seg">
              <button class="btn" data-pp="0" onclick="setPP(0)">ä¸ä¸‹</button>
              <button class="btn active" data-pp="300" onclick="setPP(300)">300</button>
              <button class="btn" data-pp="500" onclick="setPP(500)">500</button>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn-primary" id="btnDeal" onclick="deal()">ç™¼ç‰Œ</button>
          <button class="btn btn-anim" id="btnPlay" onclick="playerPlay()" disabled>è·Ÿæ³¨</button>
          <button class="btn-ghost btn-anim" id="btnFold" onclick="playerFold()" disabled>æ£„ç‰Œ</button>
          <button class="btn" onclick="newRound(true)">æ•´ç†</button>
        </div>
        <p class="status" id="status"></p>
      </div>

      <!-- è³ ç‡èªªæ˜ -->
      <div class="card pad" id="panel-pays">
        <h2>è³ ç‡ï¼ˆä¾ä½ æŒ‡å®šï¼‰</h2>
        <ul class="subtle">
          <li><strong>å´æ³¨ï¼ˆPair+ï¼‰</strong>ï¼šä¸€å° <b>1x</b>ã€åŒèŠ± <b>4x</b>ã€é †å­ <b>5x</b>ã€ä¸‰æ¢ <b>25x</b>ã€åŒèŠ±é † <b>40x</b>ï¼ˆä¸ä¸­ï¼æ²’åˆ°ä¸€å° â†’ 0ï¼›<b>æ´¾ç™¼å«æœ¬é‡‘</b>ï¼‰</li>
          <li><strong>ä¸»é«” Ante Bonus</strong>ï¼šåŒèŠ± <b>1x</b>ã€é †å­ <b>2x</b>ï¼ˆç©å®¶é”ç‰Œå‹æ™‚åŠ ç™¼ï¼›ä¸‰æ¢/åŒèŠ±é †æœªè¨­å®šåŠ ç¢¼ï¼‰</li>
          <li><strong>èŠå®¶åˆæ ¼</strong>ï¼šè‡³å°‘ <b>Q é«˜</b> æ‰æ¯”ç‰Œï¼›ä¸åˆæ ¼ â†’ <b>Ante 1:1</b>ï¼ŒPlay é€€å›ã€‚</li>
          <li><strong>ç‰Œå‹æ’å</strong>ï¼šé«˜ç‰Œ &lt; å°å­ &lt; åŒèŠ± &lt; é †å­ &lt; ä¸‰æ¢ &lt; åŒèŠ±é †ï¼ˆAâ€‘2â€‘3 æœ€å°é †ï¼›Qâ€‘Kâ€‘A æœ€å¤§é †ï¼‰ã€‚</li>
        </ul>
      </div>
    </section>

    <aside class="right">
      <div class="card pad" style="height:100%">
        <h2>ç´€éŒ„ / è¨Šæ¯</h2>
        <div id="log" class="log"></div>
      </div>
    </aside>
  </main>

<script>
// ====== å…¬ç”¨å·¥å…· ======
function money(n){return 'HKD\u00a0'+Number(n).toLocaleString('en-US',{maximumFractionDigits:0});}
function log(msg){const el=document.getElementById('log');el.innerHTML=`<div class="rowline">${msg}</div>`+el.innerHTML;}

// éŸ³æ•ˆï¼ˆç´”å‰ç«¯ WebAudioï¼‰
let _audioCtx=null;function ac(){if(!_audioCtx){_audioCtx=new (window.AudioContext||window.webkitAudioContext)()}return _audioCtx}
function beep(freq=880, dur=0.08, vol=0.05){try{const ctx=ac();const o=ctx.createOscillator();const g=ctx.createGain();o.type='sine';o.frequency.value=freq;g.gain.value=vol;o.connect(g);g.connect(ctx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);o.stop(ctx.currentTime+dur);}catch(e){}}
function playChipDing(){beep(1200,0.06,0.04);} function playActionDing(){beep(700,0.07,0.05);}

// ä¸»é¡Œåˆ‡æ› + è¨˜æ†¶
function toggleTheme(){
  const b=document.body, V='theme-vegas', N='theme-neo';
  if(b.classList.contains(V)){b.classList.remove(V);b.classList.add(N);localStorage.setItem('theme','neo');}
  else if(b.classList.contains(N)){b.classList.remove(N);localStorage.setItem('theme','default');}
  else{b.classList.add(V);localStorage.setItem('theme','vegas');}
}
(function loadPrefs(){const t=localStorage.getItem('theme');if(t==='vegas')document.body.classList.add('theme-vegas');else if(t==='neo')document.body.classList.add('theme-neo');})();

// ====== ç‰Œçµ„èˆ‡æŠ½ç‰Œ ======
const SUITS=['â™ ','â™¥','â™¦','â™£'];
const RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
function buildShoe(decks=5){const cards=[];for(let d=0;d<decks;d++){for(const s of SUITS){for(const r of RANKS){cards.push({suit:s,rank:r});}}}for(let i=cards.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[cards[i],cards[j]]=[cards[j],cards[i]]}return cards;}
let shoe=[];
function draw(n){const out=[];for(let i=0;i<n;i++){out.push(shoe.pop());}return out;}

// ====== ç‰Œå‹åˆ†æèˆ‡æ¯”è¼ƒ ======
const rankValue=r=>({'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14}[r]);
function analyze3(cards){
  const vals=cards.map(c=>rankValue(c.rank)).sort((a,b)=>a-b);const suits=cards.map(c=>c.suit);const counts={};for(const v of vals){counts[v]=(counts[v]||0)+1}
  const isFlush=(new Set(suits)).size===1;let isStraight=(vals[2]-vals[1]===1&&vals[1]-vals[0]===1);if(JSON.stringify(vals)==='[2,3,14]'){isStraight=true}
  const have3=Object.values(counts).includes(3);const havePair=Object.values(counts).includes(2);
  // 0é«˜ç‰Œ 1å° 2åŒèŠ± 3é † 4ä¸‰æ¢ 5åŒèŠ±é †
  let cat=0;if(have3)cat=4;else if(isStraight&&isFlush)cat=5;else if(isStraight)cat=3;else if(isFlush)cat=2;else if(havePair)cat=1;else cat=0;
  let sortedForCompare=[...vals];if(havePair){const pairVal=Number(Object.keys(counts).find(k=>counts[k]===2));const single=Number(Object.keys(counts).find(k=>counts[k]===1));sortedForCompare=[single,pairVal,pairVal]}
  let straightHigh=null;if(isStraight){straightHigh=(JSON.stringify(vals)==='[2,3,14]')?3:vals[2]}
  return {cat,vals,suits,havePair,have3,isFlush,isStraight,straightHigh,cmpKey:sortedForCompare};
}
function compareHands(a,b){
  if(a.cat!==b.cat)return a.cat-b.cat; if(a.cat===5||a.cat===3){return a.straightHigh-b.straightHigh}
  if(a.cat===2||a.cat===0){for(let i=2;i>=0;i--){if(a.vals[i]!==b.vals[i])return a.vals[i]-b.vals[i]}return 0}
  if(a.cat===4){return a.vals[1]-b.vals[1]} if(a.cat===1){if(a.cmpKey[1]!==b.cmpKey[1])return a.cmpKey[1]-b.cmpKey[1];return a.cmpKey[0]-b.cmpKey[0]}
  return 0;
}
function handLabel(ana){return ['é«˜ç‰Œ','ä¸€å°','åŒèŠ±','é †å­','ä¸‰æ¢','åŒèŠ±é †'][ana.cat];}

// ====== è¦å‰‡ï¼ˆä¾ä½ æŒ‡å®šï¼‰ ======
const SIDE_PAYS={pair:1,flush:4,straight:5,trips:25,straightflush:40};
const ANTE_BONUS={flush:1,straight:2,trips:0,straightflush:0};
function qualify(da){ if(da.cat>=1) return true; return da.vals[2]>=12 /*Q*/ }

// ====== ç•«é¢è¼”åŠ© ======
function renderCards(containerId,cards,hide=false){
  const el=document.getElementById(containerId);el.innerHTML='';
  cards.forEach(c=>{
    const div=document.createElement('div');div.className='card3 pop';
    if(hide){div.innerHTML='<span class="muted">ğŸ‚ </span>';}else{
      const red=(c.suit==='â™¥'||c.suit==='â™¦');div.style.borderColor=red?'#7a2f39':'#2a4a63';div.style.color=red?'#fecaca':'#e5e7eb';
      div.innerHTML=`<div style="font-size:20px">${c.rank}</div><div class="suit">${c.suit}</div>`;}
    el.appendChild(div);
  });
}
function floatPnl(pnl){const layer=document.getElementById('floatLayer');if(!layer)return;const tag=document.createElement('div');tag.className='float-pnl '+(pnl>=0?'win':'lose');tag.textContent=(pnl>=0?'+':'')+money(pnl).replace('HKD\u00A0','');layer.appendChild(tag);setTimeout(()=>tag.remove(),1300);}

// ====== ç‹€æ…‹ ======
let bankroll=20000;let stats={rounds:0,wins:0};let round=null;
function updateHUD(){document.getElementById('bankrollView').textContent=money(bankroll);if(!round){document.getElementById('pnlView').textContent='HKD\u00A00'}const wr=stats.rounds?Math.round(stats.wins*100/stats.rounds):0;document.getElementById('statsView').textContent=`${stats.rounds} / ${wr}%`;}
function setAnte(v){const el=document.getElementById('ante');if(el)el.value=v;document.querySelectorAll('[data-ante]').forEach(btn=>btn.classList.toggle('active',Number(btn.dataset.ante)===Number(v)));playChipDing();}
function setPP(v){const el=document.getElementById('pairplus');if(el)el.value=v;document.querySelectorAll('[data-pp]').forEach(btn=>btn.classList.toggle('active',Number(btn.dataset.pp)===Number(v)));playChipDing();}

// ====== çµç®—è¼”åŠ© ======
function calcPairPlus(pa,stake){if(stake<=0)return 0; if(pa.cat===5)return stake*(SIDE_PAYS.straightflush+1); if(pa.cat===4)return stake*(SIDE_PAYS.trips+1); if(pa.cat===3)return stake*(SIDE_PAYS.straight+1); if(pa.cat===2)return stake*(SIDE_PAYS.flush+1); if(pa.cat===1)return stake*(SIDE_PAYS.pair+1); return 0;}
function calcAnteBonus(pa,ante){let b=0;if(pa.cat===5)b+=ante*ANTE_BONUS.straightflush; if(pa.cat===4)b+=ante*ANTE_BONUS.trips; if(pa.cat===3)b+=ante*ANTE_BONUS.straight; if(pa.cat===2)b+=ante*ANTE_BONUS.flush;return b}

// ====== éŠæˆ²æµç¨‹ ======
function deal(){
  if(round&&!round.settled){log('å°šæœªçµç®—ï¼Œè«‹å…ˆè·Ÿæ³¨æˆ–æ£„ç‰Œ');return}
  const ante=Number(document.getElementById('ante').value)||0;const pp=Number(document.getElementById('pairplus').value)||0;
  if(ante<=0&&pp<=0){log('è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®ä¸‹æ³¨');return}
  if(bankroll<ante+pp){log('æœ¬é‡‘ä¸è¶³');return}
  const startBankroll=bankroll;bankroll-=(ante+pp);
  // æ¯å±€é‡æ´—ï¼šé‡æ–°å»ºç«‹ 5 å‰¯ç‰Œé‹
  shoe=buildShoe(5);
  const pc=draw(3),dc=draw(3);const pa=analyze3(pc),da=analyze3(dc);
  round={pc,dc,pa,da,ante,pp,play:0,settled:false,startBankroll};
  renderCards('playerCards',pc);
  const ppOnly=(ante===0&&pp>0);
  if(ppOnly){
    renderCards('dealerCards',dc,false);
    document.getElementById('playerInfo').textContent=`ä½ çš„ç‰Œï¼š${handLabel(pa)}ï¼ˆåªä¸‹å´æ³¨è‡ªå‹•çµç®—ï¼‰`;
    document.getElementById('dealerInfo').textContent=`èŠå®¶ï¼š${handLabel(da)}`;
    document.getElementById('btnPlay').disabled=true;document.getElementById('btnFold').disabled=true;document.getElementById('btnDeal').disabled=true;
    settle('PP_ONLY');
  }else{
    renderCards('dealerCards',[{},{},{}],true);
    document.getElementById('playerInfo').textContent=`ä½ çš„ç‰Œï¼š${handLabel(pa)}`;
    document.getElementById('dealerInfo').textContent='èŠå®¶ï¼šé¢æœä¸‹';
    document.getElementById('status').innerHTML='è«‹é¸æ“‡ <strong>è·Ÿæ³¨</strong> æˆ– <strong>æ£„ç‰Œ</strong>ã€‚';
    document.getElementById('btnPlay').disabled=false;document.getElementById('btnFold').disabled=false;document.getElementById('btnDeal').disabled=true;
  }
  updateHUD();
}

function playerPlay(){
  if(!round||round.settled)return;
  const btn=document.getElementById('btnPlay'); if(btn){btn.classList.remove('pulse','shake');void btn.offsetWidth;btn.classList.add('pulse')}
  if(bankroll<round.ante){if(btn){btn.classList.remove('pulse');btn.classList.add('shake')}log('æœ¬é‡‘ä¸è¶³ä»¥è·Ÿæ³¨');return}
  bankroll-=round.ante;round.play=round.ante; playActionDing();
  renderCards('dealerCards',round.dc,false);
  settle('PLAY');
}

function playerFold(){
  if(!round||round.settled)return;
  const btn=document.getElementById('btnFold'); if(btn){btn.classList.remove('pulse');void btn.offsetWidth;btn.classList.add('pulse')}
  playActionDing(); if(navigator.vibrate){navigator.vibrate(20)}
  settle('FOLD');
}

function settle(mode){
  const {pa,da,ante,play,pp,startBankroll}=round;const pairPlusReturn=calcPairPlus(pa,pp);let mainWin=0;const detail=[];

  if(mode==='PP_ONLY'){
    if(pairPlusReturn>0){bankroll+=pairPlusReturn;detail.push(`å´æ³¨æ´¾ç™¼ï¼ˆå«æœ¬é‡‘ï¼‰ ${money(pairPlusReturn)}`)}else{detail.push('å´æ³¨æœªä¸­ï¼ˆä¸€å°ä»¥ä¸Šæ‰æ´¾å½©ï¼‰')}
    round.settled=true;stats.rounds++;if(pairPlusReturn>0){stats.wins++;}
    const pnl=bankroll-startBankroll;document.getElementById('pnlView').textContent=money(pnl);document.getElementById('status').innerHTML='<strong>åªä¸‹å´æ³¨ï¼šå·²è‡ªå‹•çµç®—</strong>';floatPnl(pnl);
    log(`<span>${detail.join('ï¼›')}ã€‚</span><span class=\"amt\">${pnl>=0?`<span class=\\\"pnltag win\\\">+${money(pnl)}</span>`:`<span class=\\\"pnltag lose\\\">${money(pnl)}</span>`}</span>`);
    updateHUD();document.getElementById('btnDeal').disabled=false;document.getElementById('btnPlay').disabled=true;document.getElementById('btnFold').disabled=true;return;
  }

  if(mode==='FOLD'){
    // æ£„ç‰Œæ™‚ï¼Œå´æ³¨ä¸€åŒè¼¸æ‰ï¼Œä¸é€€å›
    detail.push('ä½ é¸æ“‡æ£„ç‰Œï¼›å¤±å» Ante èˆ‡å´æ³¨');
  } else {
    const cmp=compareHands(pa,da); const dealerQ=qualify(da);
    if(!dealerQ){
      bankroll+=ante*2; // Ante 1:1ï¼ˆå«æœ¬é‡‘ï¼‰
      bankroll+=play;   // Play é€€å›æœ¬é‡‘
      mainWin+=ante;    // ç›ˆåˆ© = Ante
      detail.push('èŠå®¶ä¸åˆæ ¼ï¼ˆQ ä»¥ä¸‹ï¼‰ï¼ŒAnte 1:1ï¼ŒPlay é€€å›');
    } else {
      if(cmp>0){
        bankroll+=(ante*2+play*2); // ä¸»é«”è´ 1:1ï¼ˆå«æœ¬é‡‘ï¼‰
        mainWin+=(ante+play);
        detail.push('ä½ è´éèŠå®¶ï¼šAnte èˆ‡ Play å„ 1:1');
      } else if(cmp<0){
        detail.push('ä½ è¼¸çµ¦èŠå®¶ï¼šAnte èˆ‡ Play çš†å¤±å»');
      } else {
        bankroll+=(ante+play); // å¹³æ‰‹é€€å›æœ¬é‡‘
        detail.push('èˆ‡èŠå®¶å¹³æ‰‹ï¼šAnte èˆ‡ Play é€€å›');
      }
    }
    const bonus=calcAnteBonus(pa,ante);if(bonus>0){bankroll+=bonus;mainWin+=bonus;detail.push(`ä¸»é«”åŠ ç¢¼ï¼š${handLabel(pa)} è¿½åŠ  ${money(bonus)}`)}
    if(pairPlusReturn>0){bankroll+=pairPlusReturn;detail.push(`å´æ³¨æ´¾ç™¼ï¼ˆå«æœ¬é‡‘ï¼‰ ${money(pairPlusReturn)}`)}
  }

  round.settled=true;stats.rounds++;if(mainWin>0||pairPlusReturn>0){stats.wins++}
  renderCards('dealerCards',round.dc,false);document.getElementById('dealerInfo').textContent=`èŠå®¶ï¼š${handLabel(da)}`;
  const pnl=bankroll-startBankroll;document.getElementById('pnlView').textContent=money(pnl);floatPnl(pnl);document.getElementById('status').innerHTML=`<strong>çµç®—å®Œæˆ</strong>ï½œä½ ï¼š${handLabel(pa)}ã€€èŠå®¶ï¼š${handLabel(da)}ã€‚`;
  log(`<span>${detail.join('ï¼›')}ã€‚</span><span class=\"amt\">${pnl>=0?`<span class=\\\"pnltag win\\\">+${money(pnl)}</span>`:`<span class=\\\"pnltag lose\\\">${money(pnl)}</span>`}</span>`);
  updateHUD();document.getElementById('btnDeal').disabled=false;document.getElementById('btnPlay').disabled=true;document.getElementById('btnFold').disabled=true;
}

function newRound(hard=false){if(hard){document.getElementById('playerCards').innerHTML='';document.getElementById('dealerCards').innerHTML='';document.getElementById('playerInfo').textContent='';document.getElementById('dealerInfo').textContent='';document.getElementById('status').textContent=''} round=null;document.getElementById('btnDeal').disabled=false;document.getElementById('btnPlay').disabled=true;document.getElementById('btnFold').disabled=true;document.getElementById('pnlView').textContent='HKD\u00A00'}

// ====== è‡ªå‹•æ¸¬è©¦ï¼ˆconsole é¡¯ç¤ºï¼‰ ======
(function runTests(){
  const ok=(name,cond)=>{if(!cond){console.error('Test failed:',name)}else{console.debug('Test ok:',name)}};
  ok('å‡½å¼å­˜åœ¨ï¼šdeal()', typeof deal==='function');
  ok('å‡½å¼å­˜åœ¨ï¼štoggleTheme()', typeof toggleTheme==='function');
  // åˆ†é¡
  ok('åˆ†é¡ï¼šé«˜ç‰Œ', analyze3([{rank:'A',suit:'â™ '},{rank:'7',suit:'â™¦'},{rank:'4',suit:'â™£'}]).cat===0);
  ok('åˆ†é¡ï¼šä¸€å°', analyze3([{rank:'K',suit:'â™ '},{rank:'K',suit:'â™¥'},{rank:'3',suit:'â™£'}]).cat===1);
  ok('åˆ†é¡ï¼šåŒèŠ±', analyze3([{rank:'2',suit:'â™¦'},{rank:'6',suit:'â™¦'},{rank:'J',suit:'â™¦'}]).cat===2);
  ok('åˆ†é¡ï¼šé †å­ A-2-3', analyze3([{rank:'A',suit:'â™ '},{rank:'2',suit:'â™¥'},{rank:'3',suit:'â™£'}]).cat===3);
  ok('åˆ†é¡ï¼šä¸‰æ¢', analyze3([{rank:'9',suit:'â™ '},{rank:'9',suit:'â™¥'},{rank:'9',suit:'â™¦'}]).cat===4);
  ok('åˆ†é¡ï¼šåŒèŠ±é † Q-K-A', analyze3([{rank:'Q',suit:'â™ '},{rank:'K',suit:'â™ '},{rank:'A',suit:'â™ '}]).cat===5);
  // æ¯”è¼ƒï¼šé †å­ > åŒèŠ±
  const straight=analyze3([{rank:'4',suit:'â™ '},{rank:'5',suit:'â™¥'},{rank:'6',suit:'â™£'}]);
  const flush=analyze3([{rank:'2',suit:'â™¦'},{rank:'7',suit:'â™¦'},{rank:'K',suit:'â™¦'}]);
  ok('æ¯”è¼ƒï¼šé †å­å‹åŒèŠ±', compareHands(straight,flush)>0);
  // æ£„ç‰Œæ™‚å´æ³¨ä¸€åŒè¼¸æ‰ï¼šAnte=300, PP=300ï¼Œæ£„ç‰Œ â†’ æå¤± 600
  (function(){const before=20000; const ante=300, pp=300; let bank = before - (ante + pp); const pnl = bank - before; ok('æ£„ç‰Œï¼šå´æ³¨ä¸€åŒè¼¸æ‰ã€æå¤± -600', pnl===-600);})();
  // Ante Bonus è¦æ ¼ï¼šåŒèŠ± 1xã€é †å­ 2x
  (function(){ ok('AnteBonus åŒèŠ± 1x', calcAnteBonus({cat:2},300)===300); ok('AnteBonus é †å­ 2x', calcAnteBonus({cat:3},300)===600); })();
  // ä½ çš„æ¡ˆä¾‹ï¼šAnte=300, Play=300, Pair+=300ï¼›ç©å®¶ä¸€å°å‹èŠå®¶é«˜ç‰Œ â†’ +900ï¼ˆå«å´æ³¨ï¼‰
  (function(){ const stakeAnte=300, stakePlay=300, stakePP=300; const before=20000; let after = before - (stakeAnte + stakePP) - stakeAnte; after += (stakeAnte*2 + stakePlay*2) + (stakePP*2); const pnl = after - before; ok('ä¸€å°å‹é«˜ç‰Œï¼ˆå«å´æ³¨ï¼‰æ‡‰ +900', pnl===900); })();
})();

// åˆå§‹åŒ–
(function init(){ setAnte(Number(document.getElementById('ante').value)); setPP(Number(document.getElementById('pairplus').value)); updateHUD(); })();
</script>
</body>
</html>
